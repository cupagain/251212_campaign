<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Xmas Campaign 2025</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <!-- Custom Config for Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        xmas: {
                            dark: '#0f172a',
                            gold: '#fbbf24',
                            red: '#ef4444',
                            green: '#10b981',
                            glass: 'rgba(255, 255, 255, 0.1)',
                        }
                    },
                    fontFamily: {
                        sans: ['Roboto', 'Noto Sans TC', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body {
            background: linear-gradient(135deg, #050505 0%, #0f172a 100%);
            color: #ffffff;
            min-height: 100vh;
        }
        
        /* 磨砂玻璃卡片效果 */
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        /* 語言切換按鈕激活狀態 */
        .lang-btn.active {
            background-color: #fbbf24; /* gold */
            color: #000;
            font-weight: bold;
        }

        /* 簡單的雪花動畫背景 (可選) */
        .snow-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            background-image: radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            z-index: 0;
            opacity: 0.5;
        }
        
        [v-cloak] { display: none; }
    </style>
</head>
<body>

<div id="app" v-cloak class="relative z-10 pb-12">
    <!-- Snow Pattern -->
    <div class="snow-bg"></div>

    <!-- Language Switcher (Floating) -->
    <div class="fixed top-4 right-4 z-50 flex gap-2">
        <button 
            v-for="lang in ['tw', 'cn', 'en', 'jp']" 
            :key="lang"
            @click="currentLang = lang"
            class="lang-btn px-3 py-1 rounded-full text-xs border border-white/20 transition hover:bg-white/20 uppercase"
            :class="{ 'active': currentLang === lang }">
            {{ lang.toUpperCase() }}
        </button>
    </div>

    <!-- Main Container -->
    <main class="max-w-md mx-auto px-4 pt-12">
        
        <!-- Header / Hero -->
        <header class="text-center mb-8 animate-fade-in-down">
            <h1 class="text-4xl font-black bg-clip-text text-transparent bg-gradient-to-r from-xmas-gold via-red-400 to-xmas-gold mb-2 drop-shadow-lg">
                {{ t.title }}
            </h1>
            <p class="text-blue-200 text-sm font-medium tracking-wide border border-blue-500/30 inline-block px-3 py-1 rounded-full bg-blue-900/20">
                {{ t.duration }}
            </p>
        </header>

        <!-- User Status Dashboard (Dynamic Data) -->
        <section class="mb-8">
            <div class="glass-card rounded-2xl p-6 relative overflow-hidden">
                <!-- Decorative Glow -->
                <div class="absolute top-0 right-0 w-32 h-32 bg-xmas-gold opacity-10 blur-3xl rounded-full pointer-events-none"></div>

                <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                    <span class="text-xmas-gold">◈</span> {{ t.myStatus }}
                </h2>

                <!-- Loading State -->
                <div v-if="loading" class="flex flex-col items-center justify-center py-8 text-gray-400">
                    <svg class="animate-spin h-8 w-8 text-xmas-gold mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span class="text-xs">{{ t.loading }}</span>
                </div>

                <!-- Error State -->
                <div v-else-if="error" class="text-center py-4">
                    <p class="text-xmas-red font-bold mb-1">{{ t.errorTitle }}</p>
                    <p class="text-xs text-gray-400">{{ error }}</p>
                    <p v-if="!userId" class="text-xs text-gray-500 mt-2">{{ t.loginRequired }}</p>
                </div>

                <!-- Data Display -->
                <div v-else class="space-y-4">
                    <!-- Rank & Diamond Grid -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-black/30 p-3 rounded-lg text-center border border-white/5">
                            <p class="text-xs text-gray-400 mb-1">{{ t.myRank }}</p>
                            <p class="text-2xl font-bold text-white">
                                {{ userData.rank ? userData.rank : '-' }}
                            </p>
                        </div>
                        <div class="bg-black/30 p-3 rounded-lg text-center border border-white/5">
                            <p class="text-xs text-gray-400 mb-1">{{ t.myDiamonds }}</p>
                            <p class="text-2xl font-bold text-blue-300 font-mono">
                                {{ formatNumber(userData.diamond_cost) }}
                            </p>
                        </div>
                    </div>

                    <!-- Eligibility Badge -->
                    <div class="flex items-center justify-between p-3 rounded-lg border"
                         :class="userData.is_eligible ? 'bg-green-900/20 border-green-500/50' : 'bg-red-900/20 border-red-500/50'">
                        <span class="text-sm font-medium">{{ t.lotteryStatus }}</span>
                        <span class="px-2 py-1 rounded text-xs font-bold"
                              :class="userData.is_eligible ? 'bg-green-500 text-black' : 'bg-red-500 text-white'">
                            {{ userData.is_eligible ? t.qualified : t.notQualified }}
                        </span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Event 1: Lucky Draw -->
        <section class="mb-6">
            <div class="glass-card rounded-2xl p-6 border-l-4 border-l-xmas-red">
                <h3 class="text-xl font-bold mb-2 text-white">{{ t.event1Title }}</h3>
                <p class="text-sm text-gray-300 mb-4">{{ t.event1Desc }}</p>
                
                <div class="bg-gradient-to-r from-xmas-red to-pink-600 rounded-lg p-4 shadow-lg text-center transform transition hover:scale-105">
                    <p class="text-xs text-white/80 mb-1 font-bold tracking-widest uppercase">{{ t.prize }}</p>
                    <p class="text-3xl font-black text-white drop-shadow-md">10,000 <span class="text-lg font-normal">{{ t.diamonds }}</span></p>
                    <p class="text-xs text-white/90 mt-1">x 50 {{ t.winners }}</p>
                </div>
            </div>
        </section>

        <!-- Event 2: Ranking -->
        <section class="mb-8">
            <div class="glass-card rounded-2xl p-6 border-l-4 border-l-xmas-gold">
                <h3 class="text-xl font-bold mb-4 text-white">{{ t.event2Title }}</h3>
                
                <div class="overflow-hidden rounded-lg border border-white/10">
                    <table class="w-full text-sm text-left">
                        <tbody class="divide-y divide-white/10">
                            <!-- Loop for Top 10 -->
                            <tr v-for="(prize, index) in rankingPrizes" :key="index" class="hover:bg-white/5 transition">
                                <td class="px-4 py-3 font-medium text-gray-300 w-24">
                                    <span v-if="index < 3" class="inline-flex items-center justify-center w-6 h-6 rounded-full bg-xmas-gold text-black font-bold text-xs">
                                        {{ index + 1 }}
                                    </span>
                                    <span v-else class="pl-2">{{ t.rankPrefix }} {{ index + 1 }}</span>
                                </td>
                                <td class="px-4 py-3 text-right text-xmas-gold font-bold font-mono">
                                    {{ formatNumber(prize) }} <span class="text-xs text-gray-500 font-normal">{{ t.diamonds }}</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Rules -->
        <section class="mb-12">
            <div class="px-2">
                <h4 class="text-sm font-bold text-gray-400 uppercase tracking-widest mb-3 border-b border-white/10 pb-2">
                    {{ t.rulesTitle }}
                </h4>
                <ul class="text-xs text-gray-400 space-y-2 list-disc list-outside pl-4 leading-relaxed">
                    <li v-for="(rule, idx) in t.rules" :key="idx">{{ rule }}</li>
                </ul>
            </div>
        </section>

    </main>
</div>

<script>
    const { createApp, ref, computed, onMounted } = Vue;

    // --- Configuration ---
    // 請在此處填入您的 Cloud Run API 網址 (Step 1 產生的)
    const API_BASE_URL = "https://op-campaign-api-xxxxxxxx-xx.a.run.app"; 

    // --- Translations ---
    const TRANSLATIONS = {
        tw: {
            title: "聖誕狂歡送",
            duration: "活動時間: 12/12 00:00 - 12/16 23:59 (GMT+8)",
            myStatus: "我的活動數據",
            loading: "正在讀取資料...",
            errorTitle: "無法取得資料",
            loginRequired: "請確認您已登入或從正確連結進入",
            myRank: "目前排名",
            myDiamonds: "累積鑽石",
            lotteryStatus: "抽獎資格",
            qualified: "已獲得",
            notQualified: "未達標",
            event1Title: "一：送禮抽萬鑽",
            event1Desc: "送「聖誕快熱」禮物 (含直播間/聊天室)，不限鑽石數即獲資格！",
            prize: "獨得獎勵",
            diamonds: "鑽石",
            winners: "位幸運兒",
            event2Title: "二：總鑽榜排名",
            rankPrefix: "第",
            rulesTitle: "活動說明",
            rules: [
                "僅限送「聖誕快熱」系列禮物，包含直播間與聊天室。",
                "排行榜鑽石相同者，以先達成者排名在前。",
                "排名鑽石獎勵將於活動結束後 3 個工作天內派發。",
                "抽獎鑽石將於活動結束後 3 個工作日內抽出並發放。",
                "資料需登入帳號以正確顯示。",
                "最終結果以官方計算為準。"
            ]
        },
        cn: {
            title: "圣诞狂欢送",
            duration: "活动时间: 12/12 00:00 - 12/16 23:59 (GMT+8)",
            myStatus: "我的活动数据",
            loading: "正在读取数据...",
            errorTitle: "无法获取数据",
            loginRequired: "请确认您已登录或从正确链接进入",
            myRank: "目前排名",
            myDiamonds: "累积钻石",
            lotteryStatus: "抽奖资格",
            qualified: "已获得",
            notQualified: "未达标",
            event1Title: "一：送礼抽万钻",
            event1Desc: "送「圣诞快热」礼物 (含直播间/聊天室)，不限钻石数即获资格！",
            prize: "独得奖励",
            diamonds: "钻石",
            winners: "位幸运儿",
            event2Title: "二：总钻榜排名",
            rankPrefix: "第",
            rulesTitle: "活动说明",
            rules: [
                "仅限送「圣诞快热」系列礼物，包含直播间与聊天室。",
                "排行榜钻石相同者，以先达成者排名在前。",
                "排名钻石奖励将于活动结束后 3 个工作天内派发。",
                "抽奖钻石将于活动结束后 3 个工作日内抽出并派发。",
                "数据需登录账号以正确显示。",
                "最终结果以官方计算为准。"
            ]
        },
        en: {
            title: "Xmas Carnival",
            duration: "Dec 12 00:00 - Dec 16 23:59 (GMT+8)",
            myStatus: "My Status",
            loading: "Loading data...",
            errorTitle: "Data Unavailable",
            loginRequired: "Please ensure you are logged in.",
            myRank: "Rank",
            myDiamonds: "Diamonds",
            lotteryStatus: "Draw Entry",
            qualified: "Qualified",
            notQualified: "Not Eligible",
            event1Title: "1. Gift to Win",
            event1Desc: "Send any 'Xmas Heat' gift (Live/Chat) to qualify instantly!",
            prize: "Grand Prize",
            diamonds: "Diamonds",
            winners: "Winners",
            event2Title: "2. Top Ranking Rewards",
            rankPrefix: "No.",
            rulesTitle: "Event Rules",
            rules: [
                "Only 'Xmas Heat' gifts count (Live & Chat included).",
                "In case of a tie, the first to achieve the score ranks higher.",
                "Ranking rewards sent within 3 working days after event.",
                "Lucky draw rewards sent within 3 working days after event.",
                "Login required to view data.",
                "Official calculation is final."
            ]
        },
        jp: {
            title: "クリスマスカーニバル",
            duration: "期間: 12/12 00:00 - 12/16 23:59 (GMT+8)",
            myStatus: "ステータス",
            loading: "読み込み中...",
            errorTitle: "データ取得不可",
            loginRequired: "ログインしているか確認してください。",
            myRank: "順位",
            myDiamonds: "ダイヤ数",
            lotteryStatus: "抽選資格",
            qualified: "獲得済み",
            notQualified: "未達成",
            event1Title: "1. ギフトで抽選",
            event1Desc: "「クリスマス・ヒート」ギフトを送るだけで抽選権獲得（ダイヤ数不問）！",
            prize: "大賞",
            diamonds: "ダイヤ",
            winners: "名様",
            event2Title: "2. ランキング報酬",
            rankPrefix: "第",
            rulesTitle: "注意事項",
            rules: [
                "「クリスマス・ヒート」ギフトのみ対象（ライブ/チャット含む）。",
                "同点の場合は、先に達成した方が上位となります。",
                "ランキング報酬はイベント終了後3営業日以内に配布。",
                "抽選報酬はイベント終了後3営業日以内に抽選・配布。",
                "データを表示するにはログインが必要です。",
                "最終結果は公式の集計に準じます。"
            ]
        }
    };

    const RANKING_PRIZES = [
        100000, 90000, 80000, 70000, 60000, 50000, 40000, 30000, 20000, 10000
    ];

    createApp({
        setup() {
            const currentLang = ref('tw');
            const userData = ref({ rank: null, diamond_cost: 0, is_eligible: false });
            const loading = ref(true);
            const error = ref(null);
            const userId = ref(null);

            // Computed Translation helper
            const t = computed(() => TRANSLATIONS[currentLang.value]);

            // Helper: Format numbers (e.g. 100,000)
            const formatNumber = (num) => {
                return num ? num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") : "0";
            };

            // Logic: Extract User ID
            const getUserId = () => {
                const url = window.location.href;
                
                // 1. Check Query Params (?user_id=)
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('user_id')) return urlParams.get('user_id');

                // 2. Check Hash Params (#user_id=)
                if (window.location.hash) {
                    const hash = window.location.hash.substring(1); // remove #
                    const hashParams = new URLSearchParams(hash);
                    if (hashParams.has('user_id')) return hashParams.get('user_id');
                }

                // 3. Regex Fallback (Find any 24-char hex string preceded by user_id=)
                // This helps with weird iframe wrappers or double-encoded URLs
                const regex = /[?&]user_id=([a-fA-F0-9]{24})/;
                const match = url.match(regex);
                if (match && match[1]) return match[1];

                return null;
            };

            const fetchData = async () => {
                userId.value = getUserId();

                if (!userId.value) {
                    error.value = "User ID not found in URL.";
                    loading.value = false;
                    return;
                }

                try {
                    // API Call
                    const response = await fetch(`${API_BASE_URL}/?user_id=${userId.value}`, {
                        method: 'GET',
                        mode: 'cors',
                        credentials: 'omit', // Important for third-party context
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!response.ok) {
                        if (response.status === 429) throw new Error("Too many requests. Please wait.");
                        if (response.status === 422) throw new Error("Invalid User ID format.");
                        throw new Error(`Server error: ${response.status}`);
                    }

                    const data = await response.json();
                    userData.value = data;
                    loading.value = false;

                } catch (err) {
                    console.error("Fetch Error:", err);
                    error.value = err.message || "Network Error";
                    loading.value = false;
                }
            };

            onMounted(() => {
                fetchData();
            });

            return {
                currentLang,
                t,
                userData,
                loading,
                error,
                rankingPrizes: RANKING_PRIZES,
                formatNumber,
                userId
            };
        }
    }).mount('#app');
</script>

</body>
</html>